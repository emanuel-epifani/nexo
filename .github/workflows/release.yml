# ==========================================
# NEXO â€” Automated Release Pipeline
# ==========================================
# Triggered when you push a version tag (v*)
# Flow: You run `npm run release` locally â†’ push â†’ this runs automatically
#
# Auth:
#   NPM  â†’ OIDC Trusted Publishing (no token needed, configure on npmjs.com)
#   Docker â†’ DOCKERHUB_USERNAME + DOCKERHUB_TOKEN secrets
#   Vercel â†’ VERCEL_TOKEN + VERCEL_ORG_ID + VERCEL_PROJECT_ID secrets

name: Release

on:
  push:
    tags: ['v*']

env:
  VERSION: ${{ github.ref_name }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. SERVER â€” Docker Image
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release-server:
    name: ğŸ³ Docker â€” Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            emanuelepifani/nexo:${{ env.VERSION }}
            emanuelepifani/nexo:latest

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. SDK â€” NPM (OIDC Trusted Publishing)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release-sdk:
    name: ğŸ“¦ NPM â€” TypeScript SDK
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          scope: '@emanuelepifani'

      - name: Update npm
        run: npm install -g npm@latest

      - name: Install dependencies
        working-directory: sdk/ts
        run: npm ci

      - name: Build SDK
        working-directory: sdk/ts
        run: npm run build --if-present

      - name: Publish to NPM
        working-directory: sdk/ts
        run: npm publish --access public --provenance

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. DOCS â€” Vercel
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release-docs:
    name: ğŸ“„ Docs â€” Website
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Deploy to Vercel
        working-directory: .
        run: npx -y vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. GITHUB RELEASE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-github-release:
    name: ğŸ‰ GitHub Release
    runs-on: ubuntu-latest
    needs: [release-server, release-sdk, release-docs]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Nexo ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          body: |
            ## Installation
            ğŸ³ `docker pull emanuelepifani/nexo:${{ github.ref_name }}`
            ğŸ“¦ `npm install @emanuelepifani/nexo-client@${{ env.VERSION }}`
